##############################################################################
# DeMoD Game Server Network - Integrated DCF Stack
#
# Architecture:
#   - Discord Bot → Game Selector → DCF-ID (auth)
#   - Game Traffic → GSN Meter (metering) → Game Servers
#   - All usage tracked and billed through Stripe
#
# Usage:
#   1. Load images as needed
#   2. Create .env file with required secrets
#   3. Prepare game files:
#      - For freedm (Zandronum):
#        • Download freedoom2.wad from https://freedoom.github.io/download.html
#        • Rename it to doom2.wad (case-sensitive: all lowercase)
#        • Place doom2.wad and your freedm.wad in ./data/
#        • Place config files in ./configs/
#      - For warfork:
#        • The image has a known bug with SteamCMD paths when using persistent volumes
#        • It may install successfully with the named volumes below, or fail — check logs
#        • If it loops/fails, consider running without the server volume (ephemeral install) or finding an alternative image
#   4. Run: docker compose up -d
#
# Copyright (c) 2025 DeMoD LLC - All Rights Reserved
##############################################################################

version: '3.9'

networks:
  dcf-bridge:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.30.0.0/16
          gateway: 172.30.0.1
  frontend:
    external: true

volumes:
  demod-data:
    external: true
    name: demod-data
  server1-data:
    driver: local
  server2-data:
    driver: local
  warfork-server:
    name: warfork-server
  warfork-logs:
    name: warfork-logs

services:
  ##############################################################################
  # Discord Bot - Ultra-lightweight command interface
  ##############################################################################
  gsn-discord-bot:
    image: alh477/demod-bot:latest
    container_name: gsn-discord-bot
    restart: unless-stopped
    environment:
      # Discord
      - DISCORD_TOKEN=${DISCORD_TOKEN}
      - BOT_PREFIX=${BOT_PREFIX:-!gs}
      - ALLOWED_ROLES=${ALLOWED_ROLES:-}
      # Internal services
      - SELECTOR_URL=http://gsn-selector:8080
      - DCF_ID_URL=http://dcf-id:4000
      - DCF_ID_INTERNAL_KEY=${DCF_ID_INTERNAL_KEY}
      # Public URLs for user-facing links
      - DCF_PUBLIC_URL=${DCF_PUBLIC_URL:-https://dcf.demod.ltd}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - RATE_LIMIT_MS=${RATE_LIMIT_MS:-2000}
    networks:
      - dcf-bridge
      - frontend
    deploy:
      resources:
        limits:
          cpus: "0.10"
          memory: 64M
    depends_on:
      gsn-selector:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1:3000/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:size=10M,mode=1777

  ##############################################################################
  # Game Selector - Orchestration with DCF-ID auth verification
  ##############################################################################
  gsn-selector:
    image: alh477/gsn-selector:latest
    container_name: gsn-selector
    restart: unless-stopped
    environment:
      # Server config
      - MAX_ACTIVE_SERVERS=2
      - SERVER_TIMEOUT_SECONDS=3600
      - DOCKER_SOCKET=/var/run/docker.sock
      - CONFIG_PATH=/share/gsn-configs
      # DCF Integration
      - DCF_ID_URL=http://dcf-id:4000
      - DCF_ID_INTERNAL_KEY=${DCF_ID_INTERNAL_KEY}
      - METER_URL=http://gsn-meter:9001
      - MIN_BALANCE_TO_START=${MIN_BALANCE_TO_START:-0.00}
      - LOG_LEVEL=${LOG_LEVEL:-info}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - demod-data:/data:ro
    networks:
      - dcf-bridge
      - frontend
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 128M
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    security_opt:
      - no-new-privileges:true

  ##############################################################################
  # Traffic Meter - Lightweight proxy that meters game traffic
  ##############################################################################
  gsn-meter:
    image: alh477/gsn-meter:latest
    container_name: gsn-meter
    restart: unless-stopped
    environment:
      - DCF_ID_URL=http://dcf-id:4000
      - DCF_ID_INTERNAL_KEY=${DCF_ID_INTERNAL_KEY}
      - UDP_PORT=9000
      - HTTP_PORT=9001
      - REPORT_INTERVAL_SECS=60
      - RUST_LOG=${LOG_LEVEL:-info}
    networks:
      - dcf-bridge
      - frontend
    ports:
      - "9001:9001/tcp"
      - "9000:9000/udp"
      - "9002:9002/udp"
      - "9003:9003/udp"
      - "9004:9004/udp"
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 128M
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1:9001/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    security_opt:
      - no-new-privileges:true

  ##############################################################################
  # Game Server Templates (Minecraft - dynamic or --profile game-active)
  ##############################################################################
  gsn-server-1:
    image: ${GAME_IMAGE:-itzg/minecraft-server:java21}
    container_name: gsn-server-1
    profiles:
      - game-active
    environment:
      - SERVER_ID=1
      - SERVER_NAME=${SERVER1_NAME:-Server-Alpha}
      - EULA=TRUE
      - DCF_GATEWAY=gsn-meter:9000
    volumes:
      - server1-data:/data
      - demod-data:/dcf:ro
    networks:
      - dcf-bridge
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 2048M
    security_opt:
      - no-new-privileges:true

  gsn-server-2:
    image: ${GAME_IMAGE:-itzg/minecraft-server:java21}
    container_name: gsn-server-2
    profiles:
      - game-active
    environment:
      - SERVER_ID=2
      - SERVER_NAME=${SERVER2_NAME:-Server-Beta}
      - EULA=TRUE
      - DCF_GATEWAY=gsn-meter:9000
    volumes:
      - server2-data:/data
      - demod-data:/dcf:ro
    networks:
      - dcf-bridge
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 2048M
    security_opt:
      - no-new-privileges:true

  ##############################################################################
  # Zandronum FreeDM Server (fixed per official image docs)
  ##############################################################################
  freedm:
    image: rcdailey/zandronum-server:official-latest
    container_name: zandronum-freedm
    hostname: freedm
    network_mode: host
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 2048M
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: 3
    command: >
      -port 8888
      -iwad /data/freedm.wad
      -file /data/freedm.wad
      +exec /configs/global.cfg
      +exec /configs/freedm.cfg
    volumes:
      - ../DCF-DOOM/data:/data:ro
      - ../DCF-DOOM/configs:/configs:ro

  ##############################################################################
  # Warfork Dedicated Server (per official README - may have install issues)
  ##############################################################################
  warfork:
    image: gelmo/warfork-docker:beta
    container_name: warfork-server
    hostname: warfork
    network_mode: host
    user: "5000:5000"
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 2048M
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: 3
    environment:
      - WF_PARAMS=+set dedicated 1 +set sv_ip 127.0.0.1 +set sv_port 8889 +set sv_hostname "Warfork Mesh-Only @ demod.ltd (DCF Required)"
    volumes:
      - warfork-server:/home/warfork/server
      - warfork-logs:/home/warfork/.local/share/warfork-2.1/basewf
      - ./custom-configs:/var/wf:ro
